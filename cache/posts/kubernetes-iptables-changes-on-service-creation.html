<p>This is simple investigation on what happens with iptables on service creation with /and without targetport specified</p>
<p>I've been recently told by someone that using target port in service creates mess in iptables so I thought it will be
cool challenge to check if thats really the case.</p>
<p>I have used simple iptables-save to get whole iptables rules at once and then added service with targetport, then cleaned iptables by deleting service and
then did the same without targetport to compare what is being added to ipt.</p>
<p>Cluster specs:</p>
<ul class="simple">
<li><p>CPU ARCH: (x86) build with kubeadm:</p></li>
<li><p>CNI: Calico</p></li>
<li><p>KubeProxy mode: iptables</p></li>
<li><p>standard etcd</p></li>
</ul>
<section id="iptables-with-targetport-in-service">
<h1>IPtables with targetport in service</h1>
<div class="code"><pre class="code bash"><a id="rest_code_e70d93586e684db19e7d5e83f74702bf-1" name="rest_code_e70d93586e684db19e7d5e83f74702bf-1" href="#rest_code_e70d93586e684db19e7d5e83f74702bf-1"></a>&gt;<span class="w"> </span>:KUBE-SEP-KVGH6HHOFLBGG2WW<span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span><span class="w"> </span>184a186
<a id="rest_code_e70d93586e684db19e7d5e83f74702bf-2" name="rest_code_e70d93586e684db19e7d5e83f74702bf-2" href="#rest_code_e70d93586e684db19e7d5e83f74702bf-2"></a>&gt;<span class="w"> </span>:KUBE-SVC-FOI3G5ZK27IESILB<span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span><span class="w"> </span>201a204,205
<a id="rest_code_e70d93586e684db19e7d5e83f74702bf-3" name="rest_code_e70d93586e684db19e7d5e83f74702bf-3" href="#rest_code_e70d93586e684db19e7d5e83f74702bf-3"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-NODEPORTS<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">31224</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_e70d93586e684db19e7d5e83f74702bf-4" name="rest_code_e70d93586e684db19e7d5e83f74702bf-4" href="#rest_code_e70d93586e684db19e7d5e83f74702bf-4"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-NODEPORTS<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">31224</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SVC-FOI3G5ZK27IESILB
<a id="rest_code_e70d93586e684db19e7d5e83f74702bf-5" name="rest_code_e70d93586e684db19e7d5e83f74702bf-5" href="#rest_code_e70d93586e684db19e7d5e83f74702bf-5"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SEP-KVGH6HHOFLBGG2WW<span class="w"> </span>-s<span class="w"> </span><span class="m">10</span>.1.167.92/32<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix-service&quot;</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_e70d93586e684db19e7d5e83f74702bf-6" name="rest_code_e70d93586e684db19e7d5e83f74702bf-6" href="#rest_code_e70d93586e684db19e7d5e83f74702bf-6"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SEP-KVGH6HHOFLBGG2WW<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>DNAT<span class="w"> </span>--to-destination<span class="w"> </span><span class="m">10</span>.1.167.92:8000
<a id="rest_code_e70d93586e684db19e7d5e83f74702bf-7" name="rest_code_e70d93586e684db19e7d5e83f74702bf-7" href="#rest_code_e70d93586e684db19e7d5e83f74702bf-7"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>!<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.0.0/16<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.105.57.223/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix-service cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">80</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_e70d93586e684db19e7d5e83f74702bf-8" name="rest_code_e70d93586e684db19e7d5e83f74702bf-8" href="#rest_code_e70d93586e684db19e7d5e83f74702bf-8"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.105.57.223/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix-service cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">80</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SVC-FOI3G5ZK27IESILB
<a id="rest_code_e70d93586e684db19e7d5e83f74702bf-9" name="rest_code_e70d93586e684db19e7d5e83f74702bf-9" href="#rest_code_e70d93586e684db19e7d5e83f74702bf-9"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SVC-FOI3G5ZK27IESILB<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix-service&quot;</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SEP-KVGH6HHOFLBGG2WW
</pre></div>
<p>As we can see in the example above the rule is to destination nat pod IP 10.1.167.92 on the port 8000 which is target
port we have specified.</p>
</section>
<section id="iptables-without-targetport-in-service">
<h1>IPtables without targetport in service</h1>
<div class="code"><pre class="code bash"><a id="rest_code_7846603756424166a4719f8e9f05ffaa-1" name="rest_code_7846603756424166a4719f8e9f05ffaa-1" href="#rest_code_7846603756424166a4719f8e9f05ffaa-1"></a>&gt;<span class="w"> </span>:KUBE-SEP-OP54BO3C6MKRBI5R<span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-2" name="rest_code_7846603756424166a4719f8e9f05ffaa-2" href="#rest_code_7846603756424166a4719f8e9f05ffaa-2"></a>&gt;<span class="w"> </span>:KUBE-SVC-FOI3G5ZK27IESILB<span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-3" name="rest_code_7846603756424166a4719f8e9f05ffaa-3" href="#rest_code_7846603756424166a4719f8e9f05ffaa-3"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-NODEPORTS<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">32681</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-4" name="rest_code_7846603756424166a4719f8e9f05ffaa-4" href="#rest_code_7846603756424166a4719f8e9f05ffaa-4"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-NODEPORTS<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">32681</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SVC-FOI3G5ZK27IESILB
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-5" name="rest_code_7846603756424166a4719f8e9f05ffaa-5" href="#rest_code_7846603756424166a4719f8e9f05ffaa-5"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SEP-OP54BO3C6MKRBI5R<span class="w"> </span>-s<span class="w"> </span><span class="m">10</span>.1.167.92/32<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix-service&quot;</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-6" name="rest_code_7846603756424166a4719f8e9f05ffaa-6" href="#rest_code_7846603756424166a4719f8e9f05ffaa-6"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SEP-OP54BO3C6MKRBI5R<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>DNAT<span class="w"> </span>--to-destination<span class="w"> </span><span class="m">10</span>.1.167.92:80
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-7" name="rest_code_7846603756424166a4719f8e9f05ffaa-7" href="#rest_code_7846603756424166a4719f8e9f05ffaa-7"></a>&lt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>!<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.0.0/16<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.96.0.1/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/kubernetes:https cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">443</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-8" name="rest_code_7846603756424166a4719f8e9f05ffaa-8" href="#rest_code_7846603756424166a4719f8e9f05ffaa-8"></a>&lt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.96.0.1/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/kubernetes:https cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">443</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SVC-NPX46M4PTMTKRN6Y
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-9" name="rest_code_7846603756424166a4719f8e9f05ffaa-9" href="#rest_code_7846603756424166a4719f8e9f05ffaa-9"></a>&lt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>!<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.0.0/16<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.96.0.10/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;kube-system/kube-dns:metrics cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">9153</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-10" name="rest_code_7846603756424166a4719f8e9f05ffaa-10" href="#rest_code_7846603756424166a4719f8e9f05ffaa-10"></a>&lt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.96.0.10/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;kube-system/kube-dns:metrics cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">9153</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SVC-JD5MR3NA4I4DYORP
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-11" name="rest_code_7846603756424166a4719f8e9f05ffaa-11" href="#rest_code_7846603756424166a4719f8e9f05ffaa-11"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>!<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.0.0/16<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.96.129.116/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix-service cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">80</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-12" name="rest_code_7846603756424166a4719f8e9f05ffaa-12" href="#rest_code_7846603756424166a4719f8e9f05ffaa-12"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.96.129.116/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix-service cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">80</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SVC-FOI3G5ZK27IESILB
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-13" name="rest_code_7846603756424166a4719f8e9f05ffaa-13" href="#rest_code_7846603756424166a4719f8e9f05ffaa-13"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>!<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.0.0/16<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.96.0.1/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/kubernetes:https cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">443</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-14" name="rest_code_7846603756424166a4719f8e9f05ffaa-14" href="#rest_code_7846603756424166a4719f8e9f05ffaa-14"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.96.0.1/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/kubernetes:https cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">443</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SVC-NPX46M4PTMTKRN6Y
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-15" name="rest_code_7846603756424166a4719f8e9f05ffaa-15" href="#rest_code_7846603756424166a4719f8e9f05ffaa-15"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>!<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.0.0/16<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.96.0.10/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;kube-system/kube-dns:metrics cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">9153</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-16" name="rest_code_7846603756424166a4719f8e9f05ffaa-16" href="#rest_code_7846603756424166a4719f8e9f05ffaa-16"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.96.0.10/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;kube-system/kube-dns:metrics cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">9153</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SVC-JD5MR3NA4I4DYORP
<a id="rest_code_7846603756424166a4719f8e9f05ffaa-17" name="rest_code_7846603756424166a4719f8e9f05ffaa-17" href="#rest_code_7846603756424166a4719f8e9f05ffaa-17"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SVC-FOI3G5ZK27IESILB<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix-service&quot;</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SEP-OP54BO3C6MKRBI5R
</pre></div>
<p>In such simple setup I would say not providing the targetport makes even bigger mess.</p>
<p>Lets see something more sophisticated so deployment with 2 replicasets</p>
</section>
<section id="with-targetport">
<h1>With targetport:</h1>
<div class="code"><pre class="code bash"><a id="rest_code_49613530119046e594fe0f61101603d2-1" name="rest_code_49613530119046e594fe0f61101603d2-1" href="#rest_code_49613530119046e594fe0f61101603d2-1"></a>&gt;<span class="w"> </span>:PREROUTING<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">4</span>:212<span class="o">]</span>
<a id="rest_code_49613530119046e594fe0f61101603d2-2" name="rest_code_49613530119046e594fe0f61101603d2-2" href="#rest_code_49613530119046e594fe0f61101603d2-2"></a>&gt;<span class="w"> </span>:INPUT<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">4</span>:212<span class="o">]</span>
<a id="rest_code_49613530119046e594fe0f61101603d2-3" name="rest_code_49613530119046e594fe0f61101603d2-3" href="#rest_code_49613530119046e594fe0f61101603d2-3"></a>&gt;<span class="w"> </span>:OUTPUT<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">29</span>:1740<span class="o">]</span>
<a id="rest_code_49613530119046e594fe0f61101603d2-4" name="rest_code_49613530119046e594fe0f61101603d2-4" href="#rest_code_49613530119046e594fe0f61101603d2-4"></a>&gt;<span class="w"> </span>:POSTROUTING<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">29</span>:1740<span class="o">]</span>
<a id="rest_code_49613530119046e594fe0f61101603d2-5" name="rest_code_49613530119046e594fe0f61101603d2-5" href="#rest_code_49613530119046e594fe0f61101603d2-5"></a>&gt;<span class="w"> </span>:KUBE-SEP-KCPMBF3JPX5ITGQR<span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
<a id="rest_code_49613530119046e594fe0f61101603d2-6" name="rest_code_49613530119046e594fe0f61101603d2-6" href="#rest_code_49613530119046e594fe0f61101603d2-6"></a>&gt;<span class="w"> </span>:KUBE-SEP-PPG4JXRVDYEFVT6U<span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
<a id="rest_code_49613530119046e594fe0f61101603d2-7" name="rest_code_49613530119046e594fe0f61101603d2-7" href="#rest_code_49613530119046e594fe0f61101603d2-7"></a>&gt;<span class="w"> </span>:KUBE-SVC-JSEMNMAXFXXWPYZQ<span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
<a id="rest_code_49613530119046e594fe0f61101603d2-8" name="rest_code_49613530119046e594fe0f61101603d2-8" href="#rest_code_49613530119046e594fe0f61101603d2-8"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-NODEPORTS<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">30329</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_49613530119046e594fe0f61101603d2-9" name="rest_code_49613530119046e594fe0f61101603d2-9" href="#rest_code_49613530119046e594fe0f61101603d2-9"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-NODEPORTS<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">30329</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SVC-JSEMNMAXFXXWPYZQ
<a id="rest_code_49613530119046e594fe0f61101603d2-10" name="rest_code_49613530119046e594fe0f61101603d2-10" href="#rest_code_49613530119046e594fe0f61101603d2-10"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SEP-KCPMBF3JPX5ITGQR<span class="w"> </span>-s<span class="w"> </span><span class="m">10</span>.1.129.5/32<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_49613530119046e594fe0f61101603d2-11" name="rest_code_49613530119046e594fe0f61101603d2-11" href="#rest_code_49613530119046e594fe0f61101603d2-11"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SEP-KCPMBF3JPX5ITGQR<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>DNAT<span class="w"> </span>--to-destination<span class="w"> </span><span class="m">10</span>.1.129.5:8000
<a id="rest_code_49613530119046e594fe0f61101603d2-12" name="rest_code_49613530119046e594fe0f61101603d2-12" href="#rest_code_49613530119046e594fe0f61101603d2-12"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SEP-PPG4JXRVDYEFVT6U<span class="w"> </span>-s<span class="w"> </span><span class="m">10</span>.1.167.83/32<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_49613530119046e594fe0f61101603d2-13" name="rest_code_49613530119046e594fe0f61101603d2-13" href="#rest_code_49613530119046e594fe0f61101603d2-13"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SEP-PPG4JXRVDYEFVT6U<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>DNAT<span class="w"> </span>--to-destination<span class="w"> </span><span class="m">10</span>.1.167.83:8000
<a id="rest_code_49613530119046e594fe0f61101603d2-14" name="rest_code_49613530119046e594fe0f61101603d2-14" href="#rest_code_49613530119046e594fe0f61101603d2-14"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>!<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.0.0/16<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.98.111.212/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">80</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_49613530119046e594fe0f61101603d2-15" name="rest_code_49613530119046e594fe0f61101603d2-15" href="#rest_code_49613530119046e594fe0f61101603d2-15"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.98.111.212/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">80</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SVC-JSEMNMAXFXXWPYZQ
<a id="rest_code_49613530119046e594fe0f61101603d2-16" name="rest_code_49613530119046e594fe0f61101603d2-16" href="#rest_code_49613530119046e594fe0f61101603d2-16"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SVC-JSEMNMAXFXXWPYZQ<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>statistic<span class="w"> </span>--mode<span class="w"> </span>random<span class="w"> </span>--probability<span class="w"> </span><span class="m">0</span>.50000000000<span class="w"> </span>-j<span class="w"> </span>KUBE-SEP-KCPMBF3JPX5ITGQR
<a id="rest_code_49613530119046e594fe0f61101603d2-17" name="rest_code_49613530119046e594fe0f61101603d2-17" href="#rest_code_49613530119046e594fe0f61101603d2-17"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SVC-JSEMNMAXFXXWPYZQ<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SEP-PPG4JXRVDYEFVT6U
</pre></div>
<p>From the following we can spot that each for our label selector in the service is listed here,
which absolutely makes sense how kube proxy would know where to send packets if not that.</p>
<p>Ok lets try with replicas without providing the port:</p>
</section>
<section id="without-targetport">
<h1>Without targetport:</h1>
<div class="code"><pre class="code bash"><a id="rest_code_b659850ab77a4870b6742afa3ef7d126-1" name="rest_code_b659850ab77a4870b6742afa3ef7d126-1" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-1"></a>&gt;<span class="w"> </span>:PREROUTING<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">4</span>:252<span class="o">]</span>
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-2" name="rest_code_b659850ab77a4870b6742afa3ef7d126-2" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-2"></a>&gt;<span class="w"> </span>:INPUT<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">4</span>:252<span class="o">]</span>
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-3" name="rest_code_b659850ab77a4870b6742afa3ef7d126-3" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-3"></a>&gt;<span class="w"> </span>:OUTPUT<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">25</span>:1500<span class="o">]</span>
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-4" name="rest_code_b659850ab77a4870b6742afa3ef7d126-4" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-4"></a>&gt;<span class="w"> </span>:POSTROUTING<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">25</span>:1500<span class="o">]</span>
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-5" name="rest_code_b659850ab77a4870b6742afa3ef7d126-5" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-5"></a>&gt;<span class="w"> </span>:KUBE-SEP-NK6MJN7AMVFQPBDQ<span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-6" name="rest_code_b659850ab77a4870b6742afa3ef7d126-6" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-6"></a>&gt;<span class="w"> </span>:KUBE-SEP-ZX65TQ3QUDHUAQQM<span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-7" name="rest_code_b659850ab77a4870b6742afa3ef7d126-7" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-7"></a>&gt;<span class="w"> </span>:KUBE-SVC-JSEMNMAXFXXWPYZQ<span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-8" name="rest_code_b659850ab77a4870b6742afa3ef7d126-8" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-8"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-NODEPORTS<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">31277</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-9" name="rest_code_b659850ab77a4870b6742afa3ef7d126-9" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-9"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-NODEPORTS<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">31277</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SVC-JSEMNMAXFXXWPYZQ
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-10" name="rest_code_b659850ab77a4870b6742afa3ef7d126-10" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-10"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SEP-NK6MJN7AMVFQPBDQ<span class="w"> </span>-s<span class="w"> </span><span class="m">10</span>.1.129.5/32<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-11" name="rest_code_b659850ab77a4870b6742afa3ef7d126-11" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-11"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SEP-NK6MJN7AMVFQPBDQ<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>DNAT<span class="w"> </span>--to-destination<span class="w"> </span><span class="m">10</span>.1.129.5:80
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-12" name="rest_code_b659850ab77a4870b6742afa3ef7d126-12" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-12"></a>&lt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>!<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.0.0/16<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.96.0.10/32<span class="w"> </span>-p<span class="w"> </span>udp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;kube-system/kube-dns:dns cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>udp<span class="w"> </span>--dport<span class="w"> </span><span class="m">53</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-13" name="rest_code_b659850ab77a4870b6742afa3ef7d126-13" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-13"></a>&lt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.96.0.10/32<span class="w"> </span>-p<span class="w"> </span>udp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;kube-system/kube-dns:dns cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>udp<span class="w"> </span>--dport<span class="w"> </span><span class="m">53</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SVC-TCOU7JCQXEZGVUNU
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-14" name="rest_code_b659850ab77a4870b6742afa3ef7d126-14" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-14"></a>---
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-15" name="rest_code_b659850ab77a4870b6742afa3ef7d126-15" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-15"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SEP-ZX65TQ3QUDHUAQQM<span class="w"> </span>-s<span class="w"> </span><span class="m">10</span>.1.167.83/32<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-16" name="rest_code_b659850ab77a4870b6742afa3ef7d126-16" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-16"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SEP-ZX65TQ3QUDHUAQQM<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>DNAT<span class="w"> </span>--to-destination<span class="w"> </span><span class="m">10</span>.1.167.83:80
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-17" name="rest_code_b659850ab77a4870b6742afa3ef7d126-17" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-17"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>!<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.0.0/16<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.108.13.83/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">80</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-18" name="rest_code_b659850ab77a4870b6742afa3ef7d126-18" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-18"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.108.13.83/32<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">80</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SVC-JSEMNMAXFXXWPYZQ
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-19" name="rest_code_b659850ab77a4870b6742afa3ef7d126-19" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-19"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>!<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.0.0/16<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.96.0.10/32<span class="w"> </span>-p<span class="w"> </span>udp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;kube-system/kube-dns:dns cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>udp<span class="w"> </span>--dport<span class="w"> </span><span class="m">53</span><span class="w"> </span>-j<span class="w"> </span>KUBE-MARK-MASQ
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-20" name="rest_code_b659850ab77a4870b6742afa3ef7d126-20" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-20"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.96.0.10/32<span class="w"> </span>-p<span class="w"> </span>udp<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;kube-system/kube-dns:dns cluster IP&quot;</span><span class="w"> </span>-m<span class="w"> </span>udp<span class="w"> </span>--dport<span class="w"> </span><span class="m">53</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SVC-TCOU7JCQXEZGVUNU
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-21" name="rest_code_b659850ab77a4870b6742afa3ef7d126-21" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-21"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SVC-JSEMNMAXFXXWPYZQ<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-m<span class="w"> </span>statistic<span class="w"> </span>--mode<span class="w"> </span>random<span class="w"> </span>--probability<span class="w"> </span><span class="m">0</span>.50000000000<span class="w"> </span>-j<span class="w"> </span>KUBE-SEP-NK6MJN7AMVFQPBDQ
<a id="rest_code_b659850ab77a4870b6742afa3ef7d126-22" name="rest_code_b659850ab77a4870b6742afa3ef7d126-22" href="#rest_code_b659850ab77a4870b6742afa3ef7d126-22"></a>&gt;<span class="w"> </span>-A<span class="w"> </span>KUBE-SVC-JSEMNMAXFXXWPYZQ<span class="w"> </span>-m<span class="w"> </span>comment<span class="w"> </span>--comment<span class="w"> </span><span class="s2">&quot;default/ngnix2-service&quot;</span><span class="w"> </span>-j<span class="w"> </span>KUBE-SEP-ZX65TQ3QUDHUAQQM
</pre></div>
<p>This needs proper investigation from me but for now what I can see
by not providing target port the iptables rules are interfering with more components like kube-dns
and  by providing the targetport its not touching kube-dns</p>
<p>To be continued...</p>
</section>
